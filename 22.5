CREATE TABLE STATS (
	STAT_ID INT(11) AUTO_INCREMENT,
    STAT_DATE DATETIME NOT NULL,
    STAT VARCHAR(20) NOT NULL,
    `VALUE` INT(11) NOT NULL,
    PRIMARY KEY (STAT_ID)
);

CREATE VIEW BESTSELLERS_COUNT AS
SELECT COUNT(*) FROM BOOKS
WHERE BESTSELLER = TRUE;

DROP EVENT IF EXISTS UPDATEBESTSELLERS;
DELIMITER $$

CREATE EVENT UPDATEBESTSELLERS
	ON SCHEDULE EVERY 1 MINUTE
    DO
    BEGIN
		DECLARE BESTSELLERS INT DEFAULT 0;
        CALL UpdateBestsellers();
        SELECT * FROM BESTSELLERS_COUNT INTO BESTSELLERS;
		INSERT INTO STATS (STAT_DATE, STAT, `VALUE`)
			VALUES (CURTIME(), "BESTSELLERS", BESTSELLERS);
    END $$

DELIMITER ;