ALTER TABLE BOOKS ADD COLUMN BESTSELLER BOOL DEFAULT 0;




DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
	DECLARE QUANTITYPERMONTH, RDR_ID INT;
	DECLARE CURMONTH INT DEFAULT MONTH(CURDATE())-1;
	DECLARE FINISHED INT DEFAULT 0;
	DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
    OPEN ALL_BOOKS;
    WHILE (FINISHED = 0) DO
		FETCH ALL_BOOKS INTO RDR_ID;
        IF (FINISHED = 0) THEN
			SELECT COUNT(*) FROM RENTS
				WHERE BOOK_ID = RDR_ID AND MONTH(RENT_DATE) = CURMONTH
					INTO QUANTITYPERMONTH;
			IF (QUANTITYPERMONTH>=2) THEN
            UPDATE BOOKS SET BESTSELLER = TRUE
				WHERE BOOK_ID = RDR_ID;
			ELSE
            UPDATE BOOKS SET BESTSELLER = FALSE
				WHERE BOOK_ID = RDR_ID;
			END IF;
			COMMIT;
		END IF;
	END WHILE;
    CLOSE ALL_BOOKS;
END $$

DELIMITER ;

CALL UpdateBestsellers();